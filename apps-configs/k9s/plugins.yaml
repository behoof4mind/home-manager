plugins:
  watch-events:
    shortCut: Shift-E
    confirm: false
    description: Get Events
    scopes:
      - all
    command: sh
    background: false
    args:
      - -c
      - watch -n 5 kubectl get events --context $CONTEXT --namespace $NAMESPACE --field-selector involvedObject.name=$NAME
  # Manage cert-manager Certificate resouces via cmctl.
  # See: https://github.com/cert-manager/cmctl
  cert-status:
    shortCut: Shift-S
    confirm: false
    description: Certificate status
    scopes:
      - certificates
    command: bash
    background: false
    args:
      - -c
      - cmctl status certificate --context $CONTEXT -n $NAMESPACE $NAME |& less
  cert-renew:
    shortCut: Shift-R
    confirm: false
    description: Certificate renew
    scopes:
      - certificates
    command: bash
    background: false
    args:
      - -c
      - cmctl renew --context $CONTEXT -n $NAMESPACE $NAME |& less
  secret-inspect:
    shortCut: Shift-I
    confirm: false
    description: Inspect secret
    scopes:
      - secrets
    command: bash
    background: false
    args:
      - -c
      - cmctl inspect secret --context $CONTEXT -n $NAMESPACE $NAME |& less
  # $HOME/.k9s/plugin.yml
  # move selected line to chosen resource in K9s, then:
  # Shift-T (with confirmation) to toggle helm releases or kustomizations suspend and resume
  # Shift-R (no confirmation) to reconcile a git source or a helm release or a kustomization
  toggle-helmrelease:
    shortCut: Shift-T
    confirm: true
    scopes:
      - helmreleases
    description: Toggle to suspend or resume a HelmRelease
    command: bash
    background: false
    args:
      - -c
      - suspended=$(kubectl --context $CONTEXT get helmreleases -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1); verb=$([ $suspended = "true" ] && echo "resume" || echo "suspend"); flux $verb helmrelease --context $CONTEXT -n $NAMESPACE $NAME | less -K
  toggle-kustomization:
    shortCut: Shift-T
    confirm: true
    scopes:
      - kustomizations
    description: Toggle to suspend or resume a Kustomization
    command: bash
    background: false
    args:
      - -c
      - suspended=$(kubectl --context $CONTEXT get kustomizations -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1); verb=$([ $suspended = "true" ] && echo "resume" || echo "suspend"); flux $verb kustomization --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-git:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - gitrepositories
    command: bash
    background: false
    args:
      - -c
      - flux reconcile source git --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-hr:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - helmreleases
    command: bash
    background: false
    args:
      - -c
      - flux reconcile helmrelease --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-helm-repo:
    shortCut: Shift-Z
    description: Flux reconcile
    scopes:
      - helmrepositories
    command: bash
    background: false
    confirm: false
    args:
      - -c
      - flux reconcile source helm --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-oci-repo:
    shortCut: Shift-Z
    description: Flux reconcile
    scopes:
      - ocirepositories
    command: bash
    background: false
    confirm: false
    args:
      - -c
      - flux reconcile source oci --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-ks:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - kustomizations
    command: bash
    background: false
    args:
      - -c
      - flux reconcile kustomization --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-ir:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imagerepositories
    command: sh
    background: false
    args:
      - -c
      - flux reconcile image repository --context $CONTEXT -n $NAMESPACE $NAME | less -K
  reconcile-iua:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imageupdateautomations
    command: sh
    background: false
    args:
      - -c
      - flux reconcile image update --context $CONTEXT -n $NAMESPACE $NAME | less -K
  trace:
    shortCut: Shift-A
    confirm: false
    description: Flux trace
    scopes:
      - all
    command: bash
    background: false
    args:
      - -c
      - resource=$(echo $RESOURCE_NAME | sed -E 's/ies$/y/' | sed -E 's/ses$/se/' | sed -E 's/(s|es)$//g') flux trace --context $CONTEXT --kind $resource --api-version $RESOURCE_GROUP/$RESOURCE_VERSION --namespace $NAMESPACE $NAME | less -K
  # credits: https://github.com/fluxcd/flux2/discussions/2494
  get-suspended-helmreleases:
    shortCut: Shift-S
    confirm: false
    description: Suspended Helm Releases
    scopes:
      - helmrelease
    command: sh
    background: false
    args:
      - -c
      - kubectl get --context $CONTEXT --all-namespaces helmreleases.helm.toolkit.fluxcd.io -o json | jq -r '.items[] | select(.spec.suspend==true) | [.metadata.namespace,.metadata.name,.spec.suspend] | @tsv' | less -K
  get-suspended-kustomizations:
    shortCut: Shift-S
    confirm: false
    description: Suspended Kustomizations
    scopes:
      - kustomizations
    command: sh
    background: false
    args:
      - -c
      - kubectl get --context $CONTEXT --all-namespaces kustomizations.kustomize.toolkit.fluxcd.io -o json | jq -r '.items[] | select(.spec.suspend==true) | [.metadata.name,.spec.suspend] | @tsv' | less -K
  #get all resources in a namespace using the krew get-all plugin
  get-all-namespace:
    shortCut: g
    confirm: false
    description: get-all
    scopes:
      - namespaces
    command: sh
    background: false
    args:
      - -c
      - kubectl get-all --context $CONTEXT -n $NAME | less -K
  get-all-other:
    shortCut: g
    confirm: false
    description: get-all
    scopes:
      - all
    command: sh
    background: false
    args:
      - -c
      - kubectl get-all --context $CONTEXT -n $NAMESPACE | less -K
  jqlogs:
    shortCut: Ctrl-J
    confirm: false
    description: Logs (jq)
    scopes:
      - po
    command: kubectl
    background: false
    args:
      - jq
      - $NAME
      - $NAMESPACE
      - $CONTEXT
  raw-logs-follow:
    shortCut: Ctrl-L
    description: logs -f
    scopes:
      - po
    command: kubectl
    background: false
    args:
      - logs
      - -f
      - $NAME
      - -n
      - $NAMESPACE
      - --context
      - $CONTEXT
      - --kubeconfig
      - $KUBECONFIG
  log-less:
    shortCut: Shift-L
    description: logs|less
    scopes:
      - po
    command: bash
    background: false
    args:
      - -c
      - '"$@" | less'
      - dummy-arg
      - kubectl
      - logs
      - $NAME
      - -n
      - $NAMESPACE
      - --context
      - $CONTEXT
      - --kubeconfig
      - $KUBECONFIG
  log-less-container:
    shortCut: Shift-L
    description: logs|less
    scopes:
      - containers
    command: bash
    background: false
    args:
      - -c
      - '"$@" | less'
      - dummy-arg
      - kubectl
      - logs
      - -c
      - $NAME
      - $POD
      - -n
      - $NAMESPACE
      - --context
      - $CONTEXT
      - --kubeconfig
      - $KUBECONFIG
